{% extends "base.html" %}
{% block title %}Administration · IEC 60870-5-104 Testbench{% endblock %}

{% block content %}
<section class="space-y-6">
  <div id="general" class="p-4 bg-slate-800 border border-slate-700 rounded">
    <h2 class="text-xl font-semibold">Allgemeine Einstellungen</h2>
    <form method="post" action="{{ url_for('admin.update_settings') }}" class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
      <label class="text-sm">
        <span class="block text-slate-300">Log Level</span>
        <select name="log_level" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
          {% for level in ['DEBUG', 'INFO', 'WARNING', 'ERROR'] %}
            <option value="{{ level }}" {% if settings.log_level == level %}selected{% endif %}>{{ level }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="text-sm">
        <span class="block text-slate-300">Ringpuffergröße</span>
        <input type="number" name="ringbuffer_size" value="{{ settings.stream.ringbuffer_size }}" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
      </label>
      <div class="md:col-span-2">
        <button class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500">Speichern</button>
      </div>
    </form>
  </div>

  <div id="ws" class="p-4 bg-slate-800 border border-slate-700 rounded">
    <h2 class="text-xl font-semibold">WebSocket Diagnose</h2>
    <button id="load-ws" class="mt-2 px-4 py-2 rounded bg-slate-700 hover:bg-slate-600 text-sm">Aktuelle Verbindungen laden</button>
    <pre id="ws-info" class="mt-3 text-xs bg-slate-900 border border-slate-700 rounded p-3 overflow-auto"></pre>
  </div>

  <div id="users" class="p-4 bg-slate-800 border border-slate-700 rounded">
    <h2 class="text-xl font-semibold">Benutzerverwaltung</h2>
    <p class="text-sm text-slate-300">Aktuell ist keine Benutzerverwaltung aktiv (Modus: {{ settings.auth.mode }}).</p>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const button = document.getElementById('load-ws');
    const target = document.getElementById('ws-info');
    if (button) {
      button.addEventListener('click', async () => {
        const response = await fetch('{{ url_for('admin.ws_diagnostics') }}');
        const data = await response.json();
        target.textContent = JSON.stringify(data, null, 2);
      });
    }
  });
</script>
{% endblock %}
